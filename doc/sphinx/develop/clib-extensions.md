# Auto-Generated CLib API

```{warning}
The auto-generated CLib API is an experimental part of Cantera and
may be changed or removed without notice.
```

In CLib, Cantera objects are stored and referenced by integers - no pointers are passed
to or from the calling application. Further, the contents of arrays and variables are
copied, which separates internal C++ memory management from the application using CLib.

## Code Generation

Before generating the CLib interface, ensure that an up-to-date Doxygen XML tree is
available. You can generate it by running:

```raw
% scons doxygen
```

The CLib interface is then generated by running the following command from the root
folder of the Cantera source code:

```raw
% python interfaces/sourcegen/run.py --api=clib --output=.
```

The CLib source generator injects the generated code directly into the Cantera source
folder by adding header files to `include/cantera/clib_experimental` and implementation
files to `src/clib_experimental`. The auto-generated CLib API becomes an integral part
of Cantera's shared libraries after compiling Cantera with the option:

```raw
% scons build clib_experimental=y
```

## CLib Source Generator Overview

The CLib source generator is located in the `interfaces/sourcegen/sourcegen/clib`
folder. While the overall configuration follows available [](sourcegen-config), the
CLib source generator introduces additional configuration options.

### Configuration

The YAML file `config.yaml` contains configuration options specific to the CLib
interface.

- **Generic Options:** These options are common across all sourcegen variants and are
  based on the names of YAML configuration files. In the context of CLib, they are
  primarily useful for code updates and maintenance:

    - `ignore_files`: A list of configuration files.
        Files listed here will be completely ignored during source generation.
    - `ignore_funcs`: A mapping of configuration file names to lists of recipe names.
        Functions listed in those files will not be scaffolded.

- **CLib-Specific Options:** These fields define options specific to the CLib interface
  and use base class names defined within the C++ Cantera namespace. Functions defined
  within Cantera's root namespace use `""` as the class name:

    - `preambles`: A mapping of class names to associated text blocks for preambles
      (headers).
    - `includes`: A mapping of class names to lists of C++ includes defining base
      classes and associated specializations.

### Implementation Details

- **Type Cross-Walks:** This section maps C++ types to their CLib equivalents.
  Implementation details for type cross-walks are defined in `_Config.py`:

    - `ret_type_crosswalk`: Specifies the types returned by C++ functions and methods.
    - `prop_type_crosswalk`: Specifies the types passed as parameters in C++ functions
      and methods.

- **Templates for Scaffolding:** Templates, powered by
  [Jinja](https://jinja.palletsprojects.com), are used to scaffold elements of the CLib
  API. The following files define these templates:

    - `templates.yaml`: Defines code blocks within the header and implementation files.
    - `header_template.h.in`: Defines the template for header files.
    - `source_template.cpp.in`: Defines the template for implementation files.

- **Source Code:** The implementation of the CLib source generator is contained in
  `_CLibSourceGenerator.py`.

## Extending the CLib API

Sourcegen uses a one-to-one correspondence of YAML configuration files to C++ base
classes; derived classes are handled by the same configuration as the base class.

- **New Methods for Existing Configurations:** Add the name of the method as a new
  recipe; the new CLib function will become available once CLib is regenerated and
  Cantera is recompiled/reinstalled.

- **YAML Configuration for a C++ Base Class:** The CLib source generator implements
  templates for C++ interface patterns commonly used by Cantera.

  Follow the following steps for new classes and associated methods:

  1. Add a new YAML configuration file as described in [](sourcegen-config).
  1. Add include files specifying base class and specializations to the `includes`
     mapping in `config.yaml`.
  1. Regenerate the CLib interface and recompile/reinstall Cantera.
  1. Add new unit tests in `test/clib_experimental` to ensure that the new feature is
     working properly.

## Troubleshooting

The **sourcegen** utility uses a logging module to provide feedback. Add the verbose
`-v` option to generate additional feedback.

- *Missing XML tree:* The sourcegen utility requires a valid doxygen tag file with with
  and associated XML tree, which are generated by running `scons doxygen`.

  ```raw
  [CRITICAL] Tag file does not exist at expected location:
      <...>/cantera/build/doc/Cantera.tag
  Run 'scons doxygen' to generate.
  ```

- *Invalid function/method name:* The function/method name is not known to doxygen;
  check spelling and/or re-run `scons doxygen` if the function/method was recently
  created.

  ```raw
  [CRITICAL] Could not find '...' in doxygen tag file.
  ```

- *Missing docstring:* Cantera's doxygen configuration skips undocumented functions and
  methods; thus, they are not part of the XML tree and cannot be resolved by sourcegen.

  ```raw
  [CRITICAL] Unable to resolve recipe type for '...'
  ```

- *Ambiguous Signature:* Functions and methods that have overloads and/or define default
  arguments require disambiguation via the `implements` field.

  ```raw
  [CRITICAL] Need argument list to disambiguate '...'.
  Possible matches are:
   - (double, double, const double*)
   - (double, double, const Composition&)
   - (double, double, const string&)
  ```

- *Missing Cross-Walk:* The CLib code generator is limited to type cross-walks
  defined `_Config.py`.

  ```raw
  [CRITICAL] Failed crosswalk for argument type '...'.
  [CRITICAL] Failed crosswalk for return type '...'.
  ```

  A resolution will require one of the two options:

  1. Create alternative C++ functions/methods with signatures that are compatible with
     existing cross-walks.
  1. Add new cross-walks to `_Config.py`, which may require updates of templates as well
     as the CLib source generator source code itself.
